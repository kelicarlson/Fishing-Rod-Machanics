-- Fishing Rod Manager (Script) Server-side 

-- What this script does: The script waits for the player to equip the rod, then listens for a click. When clicked, it clones a bait, throws it toward the mouse, and checks if it landed on water. If it landed on water, it sends a message to the player's computer to start the fishing minigame.

-- Variables
local Character = script.Parent
local RS = game:GetService("ReplicatedStorage")
local RunServ = game:GetService("RunService")
local Terrain = workspace.Terrain
local Game_Assets = RS["Game Assets"]
local Events = RS.Events
local GFD = Events["Get Fishing Data"]
local Fishing = Events.Fishing
local Fishing_Ended = Events["Fishing Ended"]
local Bates = Game_Assets["Bates"]
local Temp_Assets = workspace["Temperary Assets"]
local Temp_Bates = Temp_Assets.Bates
local MAX_THROW_SPEED = 0.5

-- Makes the bait fly! It also sets up a temporary check for when the bait hits something.
local function ThrowBate(Rod : Tool, LurePart : BasePart, Fishing_Data, Velocity)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	local MousePos = Fishing_Data.MousePos 
	local StartPosition = LurePart.Position
	local RawDirection = MousePos - StartPosition
	local UnitDirection = RawDirection.Unit
	local ImpulseVector = UnitDirection * Velocity
	ImpulseVector = ImpulseVector + Vector3.new(0, 1, 0)
	LurePart.Anchored = false
	LurePart:ApplyImpulse(ImpulseVector)
	local connection 
	local IsFishing = true
	local Tries = 0
	local MaxTries = 50
	task.wait(0.1)
	-- The bait hits something (like the ground).
	LurePart.Touched:Wait()
	repeat
		local Bound_Size = LurePart.Size
		local Target_Pos = LurePart.Position
		local increment = Bound_Size / 2
		local region = Region3.new(Target_Pos - increment, Target_Pos + increment)
		local expanded = region:ExpandToGrid(4)
		local material, occupancy = Terrain:ReadVoxels(expanded, 4)
		if material[1][1][1] == Enum.Material.Water then
			Fishing:FireClient(Player, LurePart.Position, LurePart)
			Fishing_Ended.OnServerEvent:Wait()
			IsFishing = false
			LurePart.Anchored = true
			print("Bate Thrown toward mouse position with velocity:", ImpulseVector)
			Rod.Beam.Attachment1 = nil
			LurePart:Destroy()
			break
		end
		task.wait()
		
		Tries += 1
	until Tries >= MaxTries
	Rod.Beam.Attachment1 = nil
	LurePart:Destroy()
	IsFishing = false
	repeat task.wait(1) print(IsFishing) until not IsFishing
end

print("Loading rod manager")

-- The player equips the fishing rod tool.
Character.ChildAdded:Connect(function(Tool)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local Bate = Bates["Default Bate"]
	if Tool:IsA("Tool") and Bate then
		local connection1
		local connection2
		local Beam = Tool:FindFirstChildWhichIsA("Beam")
		local Rod : Attachment = Tool.Rod
		local LurePart
		local Fishing_Complete = true
		-- The player clicks while holding the rod.
		connection1 = Tool.Activated:Connect(function()
			if Fishing_Complete then 
				if Beam.Attachment1 == nil then 
					local Fishing_Data, Velocity = GFD:InvokeClient(Player, MAX_THROW_SPEED)
					print("Rod Activated!")
					LurePart = Bate:Clone()
					LurePart.Position = Rod.WorldPosition
					LurePart.Parent = Temp_Bates
					local Attachment1 = LurePart.Bate
					Beam.Attachment0 = Tool.Rod
					Beam.Attachment1 = Attachment1
					if LurePart and LurePart:IsA("BasePart") then
						Fishing_Complete = false
						ThrowBate(Tool, LurePart, Fishing_Data, Velocity)
						Fishing_Complete = true
					else
						warn("Could not find the LurePartName!")
					end
				else 
					LurePart:Destroy()
					Beam.Attachment1 = nil
				end
			end
		end)
		
		-- The player puts the rod away.
		connection2 = Tool.Unequipped:Connect(function()
			connection1:Disconnect()
			connection2:Disconnect()
			LurePart:Destroy()
			Beam.Attachment1 = nil
		end)
	end
end)

-- Rod Reciever (LocalScript) Client-Side

-- What this localscript does: It tracks when you hold down the mouse button. When the server tells the client to start casting (using GFD.OnClientInvoke), it starts a fast loop that makes the power meter fill up on screen. The loop stops as soon as you release the mouse button. It then sends the final throwing strength and the mouse's target location back to the server so the bait can be thrown.

local Player = game.Players.LocalPlayer
local RS = game:GetService("ReplicatedStorage")
local RF = game:GetService("ReplicatedFirst")
local CAS = game:GetService("ContextActionService")
local Terrain = workspace.Terrain
local Events = RS:WaitForChild("Events")
local Modules = RS:WaitForChild("Modules")
local GFD = Events:WaitForChild("Get Fishing Data")
local Fishing = Events:WaitForChild("Fishing")
local Fishing_Ended = Events:WaitForChild("Fishing Ended")
local Components = Modules:WaitForChild("Components")
local Fishing_Minigame = require(Components["Fishing Minigame"])
local Temperary_Assets = workspace:WaitForChild("Temperary Assets")
local Temp_Bates = Temperary_Assets:WaitForChild("Bates")
local Essential_UI = RF["Essential UI"]
local Fish_Meter_UI = Essential_UI["Fish Meter UI"]
local Camera = workspace.CurrentCamera
local Mouse = Player:GetMouse()
local RealPos = Vector3.new(0,0,0)
local MouseHold = false
-- Takes the current strength and max strength, then adjusts the size of the UI bar.
local function Set_Meter(Velocity : number, MAX : number, UI)
	local Bar_Holder = UI["Bar Holder"]
	local Bar = Bar_Holder.Bar
	local scale = Velocity / MAX
	scale = math.min(scale, 1) 
	Bar.Size = UDim2.new(1, 0, scale, 0)
end
-- The Server sends a message (after detecting water contact).
Fishing.OnClientEvent:Connect(function(Pos, Bate)
	local Fish_Wait_Time = math.random(4, 10)
	print(Pos)
	RealPos = Pos
	Bate.Position = Pos
	task.wait(Fish_Wait_Time)
	print("Fish has been found")
	local Rod = script.Parent:FindFirstChildWhichIsA("Tool")
	Fishing_Minigame.Fish(Rod)
	print("Fishing complete")
	Fishing_Ended:FireServer()
end)
-- The player presses the Left Mouse Button.
Mouse.Button1Down:Connect(function()
	MouseHold = true
end)
-- The player releases the Left Mouse Button.
Mouse.Button1Up:Connect(function()
	MouseHold = false
end)
-- This is the function the Server runs on the Client when the player clicks the rod.
GFD.OnClientInvoke = function(Max_Velocity)
	print("Fishing")
	local Velocity_Units = 0
	local Max_Velocity_Units = Max_Velocity * 100 
	local New_Meter = Fish_Meter_UI:Clone()
	repeat 
		task.wait(0.15)
		if Velocity_Units < Max_Velocity_Units then 
			Velocity_Units += 5 
		end
		New_Meter.Parent = Player.PlayerGui

		print(Velocity_Units / 100) 
		Set_Meter(Velocity_Units / 100, Max_Velocity, New_Meter)
	until not MouseHold
	local finalVelocity = Velocity_Units / 100
	New_Meter:Destroy()
	return {["Vec"] = Camera.CFrame.LookVector, ["MousePos"] = Mouse.Hit.Position}, finalVelocity
end
