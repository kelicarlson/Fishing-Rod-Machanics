-- Fishing Rod Manager (Script) Server-side 

-- What this script does: The script waits for the player to equip the rod, then listens for a click. When clicked, it clones a bait, throws it toward the mouse, and checks if it landed on water. If it landed on water, it sends a message to the player's computer to start the fishing minigame.

-- Variables
local Character = script.Parent
local RS = game:GetService("ReplicatedStorage")
local RunServ = game:GetService("RunService")
local Terrain = workspace.Terrain
local Game_Assets = RS["Game Assets"]
local Events = RS.Events
local GFD = Events["Get Fishing Data"]
local Fishing = Events.Fishing
local Fishing_Ended = Events["Fishing Ended"]
local Bates = Game_Assets["Bates"]
local Temp_Assets = workspace["Temperary Assets"]
local Temp_Bates = Temp_Assets.Bates
local MAX_THROW_SPEED = 0.5

-- Makes the bait fly! It also sets up a temporary check for when the bait hits something.
local function ThrowBate(Rod : Tool, LurePart : BasePart, Fishing_Data, Velocity)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	if not Player then return end
	local MousePos = Fishing_Data.MousePos 
	local StartPosition = LurePart.Position
	local RawDirection = MousePos - StartPosition
	local UnitDirection = RawDirection.Unit
	local ImpulseVector = UnitDirection * Velocity
	ImpulseVector = ImpulseVector + Vector3.new(0, 1, 0)
	LurePart.Anchored = false
	LurePart:ApplyImpulse(ImpulseVector)
	local connection 
	local IsFishing = true
	local Tries = 0
	local MaxTries = 50
	task.wait(0.1)
	-- The bait hits something (like the ground).
	LurePart.Touched:Wait()
	repeat
		local Bound_Size = LurePart.Size
		local Target_Pos = LurePart.Position
		local increment = Bound_Size / 2
		local region = Region3.new(Target_Pos - increment, Target_Pos + increment)
		local expanded = region:ExpandToGrid(4)
		local material, occupancy = Terrain:ReadVoxels(expanded, 4)
		if material[1][1][1] == Enum.Material.Water then
			Fishing:FireClient(Player, LurePart.Position, LurePart)
			Fishing_Ended.OnServerEvent:Wait()
			IsFishing = false
			LurePart.Anchored = true
			print("Bate Thrown toward mouse position with velocity:", ImpulseVector)
			Rod.Beam.Attachment1 = nil
			LurePart:Destroy()
			break
		end
		task.wait()
		
		Tries += 1
	until Tries >= MaxTries
	Rod.Beam.Attachment1 = nil
	LurePart:Destroy()
	IsFishing = false
	repeat task.wait(1) print(IsFishing) until not IsFishing
end

print("Loading rod manager")

-- The player equips the fishing rod tool.
Character.ChildAdded:Connect(function(Tool)
	local Player = game.Players:GetPlayerFromCharacter(Character)
	local Bate = Bates["Default Bate"]
	if Tool:IsA("Tool") and Bate then
		local connection1
		local connection2
		local Beam = Tool:FindFirstChildWhichIsA("Beam")
		local Rod : Attachment = Tool.Rod
		local LurePart
		local Fishing_Complete = true
		-- The player clicks while holding the rod.
		connection1 = Tool.Activated:Connect(function()
			if Fishing_Complete then 
				if Beam.Attachment1 == nil then 
					local Fishing_Data, Velocity = GFD:InvokeClient(Player, MAX_THROW_SPEED)
					print("Rod Activated!")
					LurePart = Bate:Clone()
					LurePart.Position = Rod.WorldPosition
					LurePart.Parent = Temp_Bates
					local Attachment1 = LurePart.Bate
					Beam.Attachment0 = Tool.Rod
					Beam.Attachment1 = Attachment1
					if LurePart and LurePart:IsA("BasePart") then
						Fishing_Complete = false
						ThrowBate(Tool, LurePart, Fishing_Data, Velocity)
						Fishing_Complete = true
					else
						warn("Could not find the LurePartName!")
					end
				else 
					LurePart:Destroy()
					Beam.Attachment1 = nil
				end
			end
		end)
		
		-- The player puts the rod away.
		connection2 = Tool.Unequipped:Connect(function()
			connection1:Disconnect()
			connection2:Disconnect()
			LurePart:Destroy()
			Beam.Attachment1 = nil
		end)
	end
end)
